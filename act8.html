<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap"
    rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

  <title>Activity 8 - Text to Speech Test</title>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/act8.css') }}" />
</head>

<body>

  <!-- Main Content -->
  <main class="container" style="margin-top: 100px; background:#fff;">
    <div class="mb-5 text-center">
      <h1 class="fw-bold" style="color:var(--deep-orange);">Activity 8</h1>
      <p class="text-muted">Text to Speech Test</p>
    </div>

    <!-- Input form -->
    <div class="card shadow-sm border-0 rounded-4 p-4 mb-5">
      <h5 class="fw-bold mb-3" style="color:var(--main-orange);">Text to Speech</h5>
      
      <label for="speechInput" class="form-label">Enter text to speak:</label>
      <div class="input-group mb-3">
        <input type="text" id="speechInput" class="form-control" placeholder="Type something...">
        <button class="btn btn-main" onclick="sendSpeech()">Speak</button>
      </div>

      <!-- Language Selector -->
      <label for="langSelect" class="form-label">Select Language:</label>
      <select id="langSelect" class="form-select mb-4">
        <option value="en">English</option>
        <option value="es">Spanish</option>
        <option value="tl">Filipino (Tagalog)</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="it">Italian</option>
        <option value="ja">Japanese</option>
      </select>

      <!-- Save & Download -->
      <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-green" onclick="saveSpeech()">Save as Audio</button>
        <a id="downloadLink" class="btn btn-outline-secondary disabled" download>Download Audio</a>
      </div>
    </div>

    <!-- Saved Audio List -->
    <div class="card shadow-sm border-0 rounded-4 p-4 mb-5">
      <h5 class="fw-bold mb-3" style="color:var(--main-orange);">Saved Audio Files</h5>
      <ul id="audioList" class="list-group list-group-flush"></ul>
      <p id="lastUpdated" class="text-muted small mt-3"></p>
    </div>
  </main>

  <!-- Floating Chat Head -->
  <div id="chatHead" onclick="toggleChat(event)">
    <img src="{{ url_for('static', filename='images/Bot_32.png') }}" alt="Mini Me" />
  </div>

  <!-- Floating Chat Box -->
  <div id="chatBox" class="shadow-lg">
    <div class="chat-header d-flex justify-content-between align-items-center px-3 py-2">
      <span class="fw-bold text-white">Talking Mini Bot</span>
      <button class="btn-close btn-close-white" onclick="toggleChat()"></button>
    </div>

    <div id="botMessages" class="p-3"></div>

    <div class="chat-input d-flex p-2 border-top">
      <input type="text" id="botInput" class="form-control me-2" placeholder="Type to chat...">
      <button class="btn btn-main" onclick="talkBot()">Send</button>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Custom JS -->
  <script>
    function getLang() {
      return document.getElementById("langSelect").value;
    }

    // --- Text to Speech ---
    function sendSpeech() {
      const text = document.getElementById("speechInput").value;
      const lang = getLang();
      if (!text.trim()) { alert("Please enter some text!"); return; }

      fetch(`/act8/speak?text=${encodeURIComponent(text)}&lang=${lang}`)
        .then(res => console.log("Speech triggered"))
        .catch(err => console.error(err));
    }

    function saveSpeech() {
      const text = document.getElementById("speechInput").value;
      const lang = getLang();
      if (!text.trim()) { alert("Please enter some text!"); return; }

      fetch(`/act8/save?text=${encodeURIComponent(text)}&lang=${lang}`)
        .then(res => res.json())
        .then(data => {
          if (data.filename) {
            const link = document.getElementById("downloadLink");
            link.href = data.download_url;
            link.classList.remove("disabled");
            link.innerText = "Download Last Audio";
            loadAudioList();
          }
        }).catch(err => console.error(err));
    }

    function deleteFile(filename) {
      fetch(`/act8/delete/${filename}`, { method: "DELETE" })
        .then(res => res.json())
        .then(data => loadAudioList())
        .catch(err => console.error(err));
    }

    function loadAudioList() {
      fetch("/act8/list")
        .then(res => res.json())
        .then(files => {
          const list = document.getElementById("audioList");
          const updated = document.getElementById("lastUpdated");
          list.innerHTML = "";
          files.forEach(file => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex flex-wrap justify-content-between align-items-center";
            li.innerHTML = `
              <span>${file}</span>
              <div class="mt-2 mt-sm-0">
                <audio controls src="/static/audio/${file}" style="height:30px;"></audio>
                <a class="btn btn-sm btn-outline-primary ms-2" href="/act8/download/${file}" download>Download</a>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFile('${file}')">Delete</button>
              </div>
            `;
            list.appendChild(li);
          });
          updated.innerText = "Last updated: " + new Date().toLocaleTimeString();
        });
    }

    // --- Talking Mini Bot ---
    function talkBot() {
      const inputEl = document.getElementById("botInput");
      const msg = inputEl.value.trim();
      if (!msg) return;

      const messagesEl = document.getElementById("botMessages");

      const userMsgEl = document.createElement("div");
      userMsgEl.className = "text-end mb-2";
      userMsgEl.innerHTML = `<span class="badge bg-primary">${msg}</span>`;
      messagesEl.appendChild(userMsgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      inputEl.value = "";

      const botReply = generateBotReply(msg);

      const botMsgEl = document.createElement("div");
      botMsgEl.className = "text-start mb-2";
      botMsgEl.innerHTML = `<span class="badge bg-success">${botReply}</span>`;
      messagesEl.appendChild(botMsgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      const lang = getLang();
      fetch(`/act8/speak?text=${encodeURIComponent(botReply)}&lang=${lang}`)
        .then(res => console.log("Bot speaking..."))
        .catch(err => console.error(err));
    }

    function generateBotReply(userMsg) {
      userMsg = userMsg.toLowerCase();
      if (userMsg.includes("hello") || userMsg.includes("hi")) return "Hello! How can I help you?";
      if (userMsg.includes("how are you")) return "I'm doing great! Thanks for asking.";
      if (userMsg.includes("time")) return "The current time is " + new Date().toLocaleTimeString();
      return "You said: " + userMsg;
    }

    // --- Chat toggle ---
    function toggleChat(event) {
      // Prevent click when dragging
      if (event && event.detail === 0) return;

      const chatBox = document.getElementById("chatBox");
      chatBox.style.display = (chatBox.style.display === "flex") ? "none" : "flex";
    }

    // --- Make chathead draggable ---
    const chatHead = document.getElementById("chatHead");
    let isDragging = false, offsetX, offsetY;

    chatHead.addEventListener("mousedown", startDrag);
    chatHead.addEventListener("touchstart", startDrag);

    function startDrag(e) {
      isDragging = true;
      const rect = chatHead.getBoundingClientRect();
      offsetX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
      offsetY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

      document.addEventListener("mousemove", drag);
      document.addEventListener("mouseup", stopDrag);
      document.addEventListener("touchmove", drag);
      document.addEventListener("touchend", stopDrag);
    }

    function drag(e) {
      if (!isDragging) return;
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - offsetX;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - offsetY;

      chatHead.style.left = x + "px";
      chatHead.style.top = y + "px";
      chatHead.style.right = "auto";
      chatHead.style.bottom = "auto";
      chatHead.style.position = "fixed";
    }

    function stopDrag() {
      isDragging = false;
      document.removeEventListener("mousemove", drag);
      document.removeEventListener("mouseup", stopDrag);
      document.removeEventListener("touchmove", drag);
      document.removeEventListener("touchend", stopDrag);
    }

    // Initialize
    window.onload = () => {
      loadAudioList();
      setInterval(loadAudioList, 5000);
    };
  </script>
</body>
</html>
