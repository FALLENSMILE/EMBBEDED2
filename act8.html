<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Google Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap"
    rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">

  <title>Activity 8 - Text to Speech Test</title>
  <link rel="stylesheet" href="/css/act8.css">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
    <div class="container">
      <a href="/index.html"><img src="/images/embeddedico_32.png" alt="Logo" width="32" height="32"
          class="me-2"></a>
      <a class="navbar-brand fw-bold d-flex align-items-center" href="/index.html">
        Embedded Systems
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link active" href="/index.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="#activities">Activities</a></li>
          <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container" style="margin-top: 100px;">
    <h1 class="mb-4 fw-bold">Activity 8 - Text to Speech Test</h1>

    <!-- Input form -->
    <div class="card shadow-sm p-4 mb-4">
      <label for="speechInput" class="form-label">Enter text to speak:</label>
      <div class="input-group mb-3">
        <input type="text" id="speechInput" class="form-control" placeholder="Type something...">
        <button class="btn btn-primary" onclick="sendSpeech()">Speak</button>
      </div>

      <!-- Language Selector -->
      <label for="langSelect" class="form-label">Select Language:</label>
      <select id="langSelect" class="form-select mb-3">
        <option value="en">English</option>
        <option value="es">Spanish</option>
        <option value="tl">Filipino (Tagalog)</option>
        <option value="fr">French</option>
        <option value="de">German</option>
        <option value="it">Italian</option>
        <option value="ja">Japanese</option>
      </select>

      <!-- Save & Download -->
      <div class="d-flex gap-2">
        <button class="btn btn-success" onclick="saveSpeech()">Save as Audio</button>
        <a id="downloadLink" class="btn btn-outline-secondary disabled" download>Download Audio</a>
      </div>
    </div>

    <!-- Saved Audio List -->
    <div class="card shadow-sm p-4 mb-4">
      <h5 class="fw-bold mb-3">Saved Audio Files</h5>
      <ul id="audioList" class="list-group"></ul>
      <p id="lastUpdated" class="text-muted small mt-2"></p>
    </div>

    <!-- Talking Mini Bot -->
    <div class="card shadow-sm p-4 mb-4">
      <h5 class="fw-bold mb-3">Talking Mini Bot</h5>
      
      <div id="botMessages" class="border rounded p-3 mb-3" style="height:200px; overflow-y:auto; background:#f8f9fa;">
        <!-- Bot messages appear here -->
      </div>
      
      <div class="input-group">
        <input type="text" id="botInput" class="form-control" placeholder="Type to chat...">
        <button class="btn btn-primary" onclick="talkBot()">Send</button>
      </div>
    </div>

  </main>

  <!-- Footer -->
  <footer class="text-center py-3 bg-white border-top mt-5">
    <p class="mb-0">Â© 2025 Embedded Systems | All Rights Reserved</p>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>

  <!-- Custom JS -->
  <script>
    function getLang() {
      return document.getElementById("langSelect").value;
    }

    // --- Text to Speech ---
    function sendSpeech() {
      const text = document.getElementById("speechInput").value;
      const lang = getLang();
      if (!text.trim()) { alert("Please enter some text!"); return; }

      fetch(`/act8/speak?text=${encodeURIComponent(text)}&lang=${lang}`)
        .then(res => console.log("Speech triggered"))
        .catch(err => console.error(err));
    }

    function saveSpeech() {
      const text = document.getElementById("speechInput").value;
      const lang = getLang();
      if (!text.trim()) { alert("Please enter some text!"); return; }

      fetch(`/act8/save?text=${encodeURIComponent(text)}&lang=${lang}`)
        .then(res => res.json())
        .then(data => {
          if (data.filename) {
            const link = document.getElementById("downloadLink");
            link.href = data.download_url;
            link.classList.remove("disabled");
            link.innerText = "Download Last Audio";
            loadAudioList();
          }
        }).catch(err => console.error(err));
    }

    function deleteFile(filename) {
      fetch(`/act8/delete/${filename}`, { method: "DELETE" })
        .then(res => res.json())
        .then(data => loadAudioList())
        .catch(err => console.error(err));
    }

    function loadAudioList() {
      fetch("/act8/list")
        .then(res => res.json())
        .then(files => {
          const list = document.getElementById("audioList");
          const updated = document.getElementById("lastUpdated");
          list.innerHTML = "";
          files.forEach(file => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            li.innerHTML = `
              <span>${file}</span>
              <div>
                <audio controls src="/static/audio/${file}" style="height:30px;"></audio>
                <a class="btn btn-sm btn-outline-primary ms-2" href="/act8/download/${file}" download>Download</a>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteFile('${file}')">Delete</button>
              </div>
            `;
            list.appendChild(li);
          });
          updated.innerText = "Last updated: " + new Date().toLocaleTimeString();
        });
    }

    // --- Talking Mini Bot ---
    function talkBot() {
      const inputEl = document.getElementById("botInput");
      const msg = inputEl.value.trim();
      if (!msg) return;

      const messagesEl = document.getElementById("botMessages");

      // Add user message
      const userMsgEl = document.createElement("div");
      userMsgEl.className = "text-end mb-2";
      userMsgEl.innerHTML = `<span class="badge bg-primary">${msg}</span>`;
      messagesEl.appendChild(userMsgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      inputEl.value = "";

      // Bot reply
      const botReply = generateBotReply(msg);

      const botMsgEl = document.createElement("div");
      botMsgEl.className = "text-start mb-2";
      botMsgEl.innerHTML = `<span class="badge bg-success">${botReply}</span>`;
      messagesEl.appendChild(botMsgEl);
      messagesEl.scrollTop = messagesEl.scrollHeight;

      // Speak bot reply
      const lang = getLang();
      fetch(`/act8/speak?text=${encodeURIComponent(botReply)}&lang=${lang}`)
        .then(res => console.log("Bot speaking..."))
        .catch(err => console.error(err));
    }

    function generateBotReply(userMsg) {
      userMsg = userMsg.toLowerCase();
      if (userMsg.includes("hello") || userMsg.includes("hi")) return "Hello! How can I help you?";
      if (userMsg.includes("how are you")) return "I'm doing great! Thanks for asking.";
      if (userMsg.includes("time")) return "The current time is " + new Date().toLocaleTimeString();
      return "You said: " + userMsg;
    }

    // Initialize
    window.onload = () => {
      loadAudioList();
      setInterval(loadAudioList, 5000);
    };
  </script>
</body>
</html>
