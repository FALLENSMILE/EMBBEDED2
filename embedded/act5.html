<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Activity 5 - Sound, Rain, Temp & Humidity</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/act5.css') }}" />
</head>
<body>
  <div class="page-wrapper d-flex flex-column min-vh-100">

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
      <div class="container">
        <a href="{{ url_for('homepage') }}">
          <img src="{{ url_for('static', filename='images/embeddedico_32.png') }}" alt="Logo" width="32" height="32" class="me-2" />
        </a>
        <a class="navbar-brand fw-bold" href="{{ url_for('homepage') }}">Embedded Systems</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('homepage') }}">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('act5_page') }}">Dashboard</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('act5_history_page') }}">History</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Dashboard -->
    <main class="container my-5 pt-5">
      <div class="dashboard-container shadow-sm p-4 rounded bg-white">
        <h1 class="text-center mb-3" style="color: var(--main-orange);">Sound, Rain & Climate Dashboard</h1>
        <p id="countdown" class="text-center mb-4">Next update in: 2s</p>

        <!-- First row: Sound & Rain -->
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="reading text-center my-2">
              <span id="sound-status" class="fw-semibold">Sound: --</span>
            </div>
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="card-title text-center">Live Sound Sensor Readings</h5>
                <canvas id="soundChart"></canvas>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="reading text-center my-2">
              <span id="rain-status" class="fw-semibold">Rain: --</span>
            </div>
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="card-title text-center">Live Rain Sensor Readings</h5>
                <canvas id="rainChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Second row: Temperature & Humidity -->
        <div class="row">
          <div class="col-md-6 mb-4">
            <div class="reading text-center my-2">
              <span id="temp-status" class="fw-semibold">Temperature: -- °C</span>
            </div>
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="card-title text-center">Live Temperature Readings</h5>
                <canvas id="tempChart"></canvas>
              </div>
            </div>
          </div>

          <div class="col-md-6 mb-4">
            <div class="reading text-center my-2">
              <span id="hum-status" class="fw-semibold">Humidity: -- %</span>
            </div>
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <h5 class="card-title text-center">Live Humidity Readings</h5>
                <canvas id="humChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-3 bg-white border-top mt-auto">
      <p class="mb-0">© 2025 Embedded Systems | All Rights Reserved</p>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const maxPoints = 20;

    // --- Sound Chart ---
    const soundCtx = document.getElementById("soundChart").getContext("2d");
    const soundLabels = [], soundAnalog = [];
    const soundChart = new Chart(soundCtx, {
      type: "line",
      data: {
        labels: soundLabels,
        datasets: [{
          label: "Sound (Analog)",
          data: soundAnalog,
          borderColor: "orange",
          backgroundColor: "rgba(255,165,0,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    // --- Rain Chart ---
    const rainCtx = document.getElementById("rainChart").getContext("2d");
    const rainLabels = [], rainAnalog = [];
    const rainChart = new Chart(rainCtx, {
      type: "line",
      data: {
        labels: rainLabels,
        datasets: [{
          label: "Rain (Analog)",
          data: rainAnalog,
          borderColor: "blue",
          backgroundColor: "rgba(0,0,255,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    // --- Temperature Chart ---
    const tempCtx = document.getElementById("tempChart").getContext("2d");
    const tempLabels = [], tempData = [];
    const tempChart = new Chart(tempCtx, {
      type: "line",
      data: {
        labels: tempLabels,
        datasets: [{
          label: "Temperature (°C)",
          data: tempData,
          borderColor: "red",
          backgroundColor: "rgba(255,0,0,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    // --- Humidity Chart ---
    const humCtx = document.getElementById("humChart").getContext("2d");
    const humLabels = [], humData = [];
    const humChart = new Chart(humCtx, {
      type: "line",
      data: {
        labels: humLabels,
        datasets: [{
          label: "Humidity (%)",
          data: humData,
          borderColor: "green",
          backgroundColor: "rgba(0,128,0,0.2)",
          fill: true,
          tension: 0.3
        }]
      },
      options: { responsive: true }
    });

    // --- Fetch Data and Update Charts ---
    async function fetchData() {
      try {
        const res = await fetch("/act5/data");
        const d = await res.json();
        const now = new Date().toLocaleTimeString();

        // Sound
        document.getElementById("sound-status").innerText =
          `Sound: ${d.sound_digital[d.sound_digital.length-1] ? "Detected" : "None"} (Analog: ${d.sound_analog[d.sound_analog.length-1]})`;
        soundLabels.push(now);
        soundAnalog.push(d.sound_analog[d.sound_analog.length-1]);
        if (soundLabels.length > maxPoints) { soundLabels.shift(); soundAnalog.shift(); }
        soundChart.update();

        // Rain
        document.getElementById("rain-status").innerText =
          `Rain: ${d.rain_digital[d.rain_digital.length-1] ? "Detected" : "None"} (Analog: ${d.rain_analog[d.rain_analog.length-1]})`;
        rainLabels.push(now);
        rainAnalog.push(d.rain_analog[d.rain_analog.length-1]);
        if (rainLabels.length > maxPoints) { rainLabels.shift(); rainAnalog.shift(); }
        rainChart.update();

        // Temperature
        document.getElementById("temp-status").innerText =
          `Temperature: ${d.temperature[d.temperature.length-1] ?? '--'} °C`;
        tempLabels.push(now);
        tempData.push(d.temperature[d.temperature.length-1] ?? null);
        if (tempLabels.length > maxPoints) { tempLabels.shift(); tempData.shift(); }
        tempChart.update();

        // Humidity
        document.getElementById("hum-status").innerText =
          `Humidity: ${d.humidity[d.humidity.length-1] ?? '--'} %`;
        humLabels.push(now);
        humData.push(d.humidity[d.humidity.length-1] ?? null);
        if (humLabels.length > maxPoints) { humLabels.shift(); humData.shift(); }
        humChart.update();

      } catch (err) {
        console.error("Fetch failed", err);
      }
    }

    // Auto-update every 2s with countdown
    let countdown = 2;
    setInterval(() => {
      countdown--;
      if (countdown <= 0) {
        fetchData();
        countdown = 2;
      }
      document.getElementById("countdown").innerText = `Next update in: ${countdown}s`;
    }, 1000);

    fetchData();
  </script>
</body>
</html>
