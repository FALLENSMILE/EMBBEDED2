<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:opsz,wght@12..96,200..800&display=swap" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

  <title>Activity 4 - Vibration & Gas Sensors</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/act4.css') }}" />
</head>
<body>
  <div class="page-wrapper d-flex flex-column min-vh-100">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
      <div class="container">
        <a href="{{ url_for('homepage') }}">
          <img src="{{ url_for('static', filename='images/embeddedico_32.png') }}" alt="Logo" width="32" height="32" class="me-2" />
        </a>
        <a class="navbar-brand fw-bold" href="{{ url_for('homepage') }}">Embedded Systems</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('homepage') }}">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="#activities">Activities</a></li>
            <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Dashboard -->
    <main class="container my-5 pt-5">
      <div class="dashboard-container shadow-sm p-4 rounded bg-white">

        <h1 class="text-center mb-3" style="color: var(--main-orange);">Vibration and Gas Sensor Dashboard</h1>
        <p id="countdown" class="text-center mb-4">Next update in: 2s</p>

        <!-- Buzzer Status -->
        <div id="buzzer-status" class="buzzer-inactive text-center">
          <i id="buzzer-icon" class="bi bi-bell-slash-fill"></i>
          Buzzer: OFF
        </div>

        <!-- Vibration Status -->
        <div class="reading text-center my-3">
          <span id="vibration-status" class="fw-semibold">Vibration: --</span>
        </div>

        <!-- Vibration Chart -->
        <div class="card border-0 shadow-sm mb-5">
          <div class="card-body">
            <h5 class="card-title text-center" style="color: var(--deep-orange);">Live Vibration Readings</h5>
            <canvas id="vibrationChart"></canvas>
          </div>
        </div>

        <!-- Gas Sensor Status -->
        <div class="reading text-center my-3">
          <span id="gas-status" class="fw-semibold">MQ-2 Gas Sensor Value: --</span>
        </div>

        <!-- Gas Chart -->
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <h5 class="card-title text-center" style="color: var(--accent-green);">Live Gas Sensor Readings</h5>
            <canvas id="gasChart"></canvas>
            <div class="text-center mt-3 small">
              <span class="me-3"><span class="legend-color" style="background:green;"></span>Good</span>
              <span class="me-3"><span class="legend-color" style="background:orange;"></span>Moderate</span>
              <span><span class="legend-color" style="background:red;"></span>Danger</span>
            </div>
          </div>
        </div>

      </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-3 bg-white border-top mt-auto">
      <p class="mb-0">Â© 2025 Embedded Systems | All Rights Reserved</p>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>

  <script>
    const maxPoints = 20;

    // Vibration Chart Setup
    const vibCtx = document.getElementById("vibrationChart").getContext("2d");
    const vibGradient = vibCtx.createLinearGradient(0, 0, 0, 300);
    vibGradient.addColorStop(0, "rgba(255, 165, 0, 0.3)");
    vibGradient.addColorStop(1, "rgba(255, 165, 0, 0)");

    const vibLabels = [];
    const vibDataPoints = [];

    const vibrationChart = new Chart(vibCtx, {
      type: 'line',
      data: {
        labels: vibLabels,
        datasets: [{
          label: 'Vibration',
          data: vibDataPoints,
          borderColor: 'var(--main-orange)',
          backgroundColor: vibGradient,
          tension: 0.4,
          fill: true,
          pointRadius: 5,
          pointHoverRadius: 6,
          pointBackgroundColor: function (context) {
            const value = context.raw;
            return value === 1 ? 'red' : 'green';
          },
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.7)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'var(--main-orange)',
            borderWidth: 1,
            padding: 10
          },
          annotation: {
            annotations: {
              thresholdLine: {
                type: 'line',
                yMin: 0.5,
                yMax: 0.5,
                borderColor: 'orange',
                borderWidth: 2,
                label: {
                  enabled: true,
                  content: 'Warning Threshold',
                  backgroundColor: 'rgba(255,165,0,0.7)',
                  color: 'black',
                  position: 'start',
                  yAdjust: -10,
                  font: { weight: 'bold' }
                }
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#888', font: { size: 12 } },
            grid: { display: false },
            title: {
              display: true,
              text: 'Time',
              color: '#666',
              font: { weight: 'bold' }
            }
          },
          y: {
            min: -0.1,
            max: 1.1,
            ticks: {
              stepSize: 0.5,
              color: '#888',
              callback: v => {
                if (v === 1) return 'Detected';
                if (v === 0) return 'None';
                return '';
              }
            },
            grid: { color: 'rgba(0,0,0,0.05)' },
            title: {
              display: true,
              text: 'Vibration Level',
              color: '#666',
              font: { weight: 'bold' }
            }
          }
        }
      }
    });

    // Gas Chart Setup
    const gasCtx = document.getElementById("gasChart").getContext("2d");
    const gasLabels = [];
    const gasDataPoints = [];

    // Custom plugin for colored area fill by threshold
    const gasGradientPlugin = {
      id: 'gasGradientPlugin',
      beforeDatasetsDraw(chart) {
        const {
          ctx,
          chartArea: { top, bottom },
          scales: { x, y }
        } = chart;

        const dataset = chart.data.datasets[0];
        const meta = chart.getDatasetMeta(0);
        const points = meta.data;

        ctx.save();

        for (let i = 0; i < points.length - 1; i++) {
          const p1 = points[i];
          const p2 = points[i + 1];
          const v1 = dataset.data[i];
          const v2 = dataset.data[i + 1];

          if (p1 && p2 && v1 !== undefined && v2 !== undefined) {
            let color = null;

            if (v1 >= 600 && v2 >= 600) {
              color = 'rgba(255, 0, 0, 0.3)';
            } else if (v1 >= 300 && v2 >= 300) {
              color = 'rgba(255, 165, 0, 0.3)';
            } else if (v1 < 300 && v2 < 300) {
              color = 'rgba(22, 146, 74, 0.3)';
            }

            if (color) {
              const gradient = ctx.createLinearGradient(0, top, 0, bottom);
              gradient.addColorStop(0, color);
              gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');

              ctx.beginPath();
              ctx.moveTo(p1.x, y.getPixelForValue(0));
              ctx.lineTo(p1.x, p1.y);
              ctx.lineTo(p2.x, p2.y);
              ctx.lineTo(p2.x, y.getPixelForValue(0));
              ctx.closePath();

              ctx.fillStyle = gradient;
              ctx.fill();
            }
          }
        }

        ctx.restore();
      }
    };

    const gasChart = new Chart(gasCtx, {
      type: 'line',
      data: {
        labels: gasLabels,
        datasets: [{
          label: 'MQ-2 Gas Sensor',
          data: gasDataPoints,
          borderColor: 'var(--accent-green)',
          backgroundColor: null,
          tension: 0.4,
          fill: false,
          pointRadius: 5,
          pointHoverRadius: 6,
          pointBackgroundColor: function (context) {
            const value = context.raw;
            if (value >= 600) return 'red';
            else if (value >= 300) return 'orange';
            return 'green';
          },
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: true },
          tooltip: {
            backgroundColor: 'rgba(0,0,0,0.7)',
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: 'var(--accent-green)',
            borderWidth: 1,
            padding: 10
          }
        },
        scales: {
          x: {
            ticks: { color: '#888' },
            grid: { color: 'rgba(0,0,0,0.05)' },
            title: {
              display: true,
              text: 'Time',
              color: '#666',
              font: { weight: 'bold' }
            }
          },
          y: {
            beginAtZero: true,
            ticks: { color: '#888' },
            grid: { color: 'rgba(0,0,0,0.05)' },
            title: {
              display: true,
              text: 'Gas Value',
              color: '#666',
              font: { weight: 'bold' }
            }
          }
        }
      },
      plugins: [gasGradientPlugin]
    });

    // Fetch Data
    async function fetchCurrentReading() {
      try {
        const res = await fetch("/act4/readings");
        const data = await res.json();
        const now = new Date().toLocaleTimeString();

        // Vibration
        const vibration = data.vibration ? 1 : 0;
        document.getElementById("vibration-status").innerText = `Vibration: ${vibration ? "Detected" : "None"}`;
        document.getElementById("buzzer-status").className = vibration ? "buzzer-active text-center" : "buzzer-inactive text-center";
        document.getElementById("buzzer-status").innerHTML = `
          <i class="${vibration ? "bi bi-bell-fill" : "bi bi-bell-slash-fill"}"></i>
          Buzzer: ${vibration ? "ON" : "OFF"}
        `;
        vibLabels.push(now);
        vibDataPoints.push(vibration);
        if (vibLabels.length > maxPoints) {
          vibLabels.shift();
          vibDataPoints.shift();
        }
        vibrationChart.update();

        // Gas
        const gasValue = data.mq2 || 0;
        document.getElementById("gas-status").innerText = `MQ-2 Gas Sensor Value: ${gasValue}`;
        gasLabels.push(now);
        gasDataPoints.push(gasValue);
        if (gasLabels.length > maxPoints) {
          gasLabels.shift();
          gasDataPoints.shift();
        }
        gasChart.update();
      } catch (err) {
        console.error("Failed to fetch current reading", err);
      }
    }

    // Auto update
    let countdown = 2;
    setInterval(async () => {
      countdown--;
      if (countdown <= 0) {
        await fetchCurrentReading();
        countdown = 2;
      }
      document.getElementById("countdown").innerText = `Next update in: ${countdown}s`;
    }, 1000);

    fetchCurrentReading();
  </script>
</body>
</html>
