<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600&display=swap" rel="stylesheet" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />

  <title>Activity 6 - GPS Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/act6.css') }}" />
  <style>
    #map { height: 400px; border-radius: 10px; }
    #map-container { display: none; }
    canvas { max-height: 300px; }
  </style>
</head>
<body>
  <div class="page-wrapper d-flex flex-column min-vh-100">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
      <div class="container">
        <a href="{{ url_for('homepage') }}">
          <img src="{{ url_for('static', filename='images/embeddedico_32.png') }}" alt="Logo" width="32" height="32" class="me-2" />
        </a>
        <a class="navbar-brand fw-bold" href="{{ url_for('homepage') }}">Embedded Systems</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('homepage') }}">Home</a></li>
            <li class="nav-item"><a class="nav-link" href="#activities">Activities</a></li>
            <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Main Dashboard -->
    <main class="container my-5 pt-5">
      <div class="dashboard-container shadow-sm p-4 rounded bg-white">
        <h1 class="text-center mb-3" style="color: var(--main-orange);">GPS Dashboard</h1>
        <p id="countdown" class="text-center mb-4">Next update in: 2s</p>

        <!-- MPU Graphs -->
        <div class="row mb-4">
          <div class="col-md-6">
            <h5 class="text-center">Accelerometer (m/s²)</h5>
            <canvas id="accelChart"></canvas>
          </div>
          <div class="col-md-6">
            <h5 class="text-center">Gyroscope (rad/s)</h5>
            <canvas id="gyroChart"></canvas>
          </div>
        </div>

        <!-- GPS Info -->
        <div class="row text-center mb-4">
          <div class="col-md-4"><strong>Latitude:</strong> <span id="gps-lat">--</span></div>
          <div class="col-md-4"><strong>Longitude:</strong> <span id="gps-lon">--</span></div>
          <div class="col-md-4"><strong>Status:</strong> <span id="gps-status">--</span></div>
        </div>
        <div class="row text-center mb-4">
          <div class="col-md-4"><strong>Speed (knots):</strong> <span id="gps-speed-knots">--</span></div>
          <div class="col-md-4"><strong>Speed (km/h):</strong> <span id="gps-speed-kmh">--</span></div>
          <div class="col-md-4"><strong>Course:</strong> <span id="gps-course">--</span></div>
        </div>
        <div class="text-center mb-4">
          <strong>Timestamp:</strong> <span id="gps-time">--</span>
        </div>

        <!-- Toggle Map Button -->
        <div class="text-center mb-3">
          <button id="toggle-map" class="btn btn-primary">
            <i class="bi bi-map"></i> Show Map
          </button>
        </div>

        <!-- Google Map -->
        <div id="map-container">
          <div id="map"></div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-3 bg-white border-top mt-auto">
      <p class="mb-0">© 2025 Embedded Systems | All Rights Reserved</p>
    </footer>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    let map, marker, pathPolyline;
    let pathCoords = [];
    const updateInterval = 2;
    let countdown = updateInterval;
    let hasAnnouncedLocation = false;

    // Chart.js setup
    const accelCtx = document.getElementById("accelChart").getContext("2d");
    const gyroCtx = document.getElementById("gyroChart").getContext("2d");

    const chartOptions = {
      responsive: true,
      animation: false,
      scales: {
        x: { display: false },
        y: { beginAtZero: true }
      }
    };

    const accelChart = new Chart(accelCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          { label: "X", borderColor: "red", data: [], fill: false },
          { label: "Y", borderColor: "green", data: [], fill: false },
          { label: "Z", borderColor: "blue", data: [], fill: false }
        ]
      },
      options: chartOptions
    });

    const gyroChart = new Chart(gyroCtx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          { label: "X", borderColor: "orange", data: [], fill: false },
          { label: "Y", borderColor: "purple", data: [], fill: false },
          { label: "Z", borderColor: "brown", data: [], fill: false }
        ]
      },
      options: chartOptions
    });

    function updateChart(chart, values) {
      const now = new Date().toLocaleTimeString();
      chart.data.labels.push(now);
      chart.data.datasets.forEach((ds, i) => {
        ds.data.push(values[i]);
        if (ds.data.length > 20) {
          ds.data.shift();
          chart.data.labels.shift();
        }
      });
      chart.update();
    }

    async function fetchMPU() {
      try {
        const res = await fetch("/act6/mpu");
        const data = await res.json();

        if (data.accel_x !== null) {
          updateChart(accelChart, [data.accel_x, data.accel_y, data.accel_z]);
          updateChart(gyroChart, [data.gyro_x, data.gyro_y, data.gyro_z]);
        }
      } catch (err) {
        console.error("MPU fetch failed:", err);
      }
    }

    // Existing GPS functions remain unchanged...
    async function fetchGPS() {
      try {
        const res = await fetch("/act6/gps");
        const data = await res.json();

        document.getElementById("gps-lat").innerText = data.latitude ?? "--";
        document.getElementById("gps-lon").innerText = data.longitude ?? "--";
        document.getElementById("gps-status").innerText = data.status ?? "--";
        document.getElementById("gps-speed-knots").innerText = data.speed_knots ?? "--";
        document.getElementById("gps-speed-kmh").innerText = data.speed_kmh ?? "--";
        document.getElementById("gps-course").innerText = data.course ?? "--";
        document.getElementById("gps-time").innerText = data.timestamp ?? "--";

        const toggleBtn = document.getElementById("toggle-map");

        if (!data.latitude || !data.longitude || data.status?.toLowerCase() === "calibrating") {
          toggleBtn.disabled = true;
          toggleBtn.innerHTML = '<i class="bi bi-exclamation-circle"></i> Unavailable, map calibrating';
          document.getElementById("map-container").style.display = "none";
          hasAnnouncedLocation = false;
          return;
        } else {
          toggleBtn.disabled = false;
          toggleBtn.innerHTML = '<i class="bi bi-map"></i> Show Map';
        }

        if (!hasAnnouncedLocation && data.latitude && data.longitude && data.status === "A") {
          const msg = new SpeechSynthesisUtterance(`GPS calibrated. Your location is latitude ${data.latitude}, longitude ${data.longitude}`);
          window.speechSynthesis.speak(msg);
          hasAnnouncedLocation = true;
        }

        if (map) {
          const lat = parseFloat(data.latitude);
          const lon = parseFloat(data.longitude);
          const position = { lat, lng: lon };

          if (!marker) {
            marker = new google.maps.Marker({
              position: position,
              map: map,
              title: "Current Position",
            });
            map.setCenter(position);
            map.setZoom(16);
          } else {
            marker.setPosition(position);
          }

          pathCoords.push(position);
          pathPolyline.setPath(pathCoords);
          map.panTo(position);
        }
      } catch (err) {
        console.error("GPS fetch failed:", err);
      }
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 0, lng: 0 },
        zoom: 2,
      });

      pathPolyline = new google.maps.Polyline({
        path: pathCoords,
        geodesic: true,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 3,
        map: map,
      });
    }

    // Countdown + auto-update
    setInterval(() => {
      countdown--;
      if (countdown <= 0) {
        fetchGPS();
        fetchMPU();
        countdown = updateInterval;
      }
      document.getElementById("countdown").innerText = `Next update in: ${countdown}s`;
    }, 1000);

    document.getElementById("toggle-map").addEventListener("click", () => {
      const container = document.getElementById("map-container");
      const button = document.getElementById("toggle-map");

      if (button.disabled) return;

      if (container.style.display === "none") {
        container.style.display = "block";
        button.innerHTML = '<i class="bi bi-map-fill"></i> Hide Map';
        if (map) {
          google.maps.event.trigger(map, "resize");
        }
      } else {
        container.style.display = "none";
        button.innerHTML = '<i class="bi bi-map"></i> Show Map';
      }
    });

    window.initMap = initMap;
  </script>

  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAWkF98bgQgrdkZPRDrobeNag_PAOgT6SI&callback=initMap" async defer></script>
</body>
</html>
